<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æˆç”°ç©ºæ¸¯è¡Œãåˆ—è»Šä½ç½®æƒ…å ±</title>
  <style>
    body{
      font-family: sans-serif;
      margin: 10px;
      padding: 0;
      background:#f4f4f4;
    }
    h1{
      font-size: 1.2em;
      text-align:center;
      margin: 8px 0 6px;
    }

    #info-message{
      text-align:center;
      font-size:0.9em;
      color:#333;
      margin: 4px 0 10px;
      line-height: 1.35;
    }

    #alert-banner{
      display:none;
      margin: 8px 0 10px;
      padding: 12px 14px;
      border-radius: 12px;
      background: #fff3cd;
      border-left: 6px solid #dc3545;
      color: #7a0000;
      line-height: 1.4;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    #alert-banner .title{
      font-weight: bold;
      margin-bottom: 4px;
    }

    .card{
      background:#fff;
      border-radius:12px;
      overflow:hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    #line-svg{
      width:100%;
      height: 1100px;
      display:block;
      background:#fff;
    }

    #last-updated{
      font-size:0.85em;
      color:#666;
      text-align:center;
      margin:10px 0 0;
    }

    .train-marker{ cursor:pointer; }

    /* ====== ãƒ¢ãƒ¼ãƒ€ãƒ« ====== */
    #modal-overlay{
      display:none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 9999;
      padding: 16px;
      box-sizing: border-box;
    }
    #modal{
      max-width: 520px;
      margin: 10vh auto 0;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 10px 28px rgba(0,0,0,0.25);
      overflow: hidden;
    }
    #modal-header{
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 12px 14px;
      background: #f6f6f6;
      border-bottom: 1px solid #e6e6e6;
    }
    #modal-title{
      font-weight: bold;
      font-size: 1.0em;
      color:#222;
    }
    #modal-close{
      appearance: none;
      border: none;
      background: transparent;
      font-size: 22px;
      line-height: 1;
      cursor: pointer;
      padding: 6px 8px;
      color:#333;
    }
    #modal-body{
      padding: 12px 14px 14px;
    }
    #modal-body .row{
      margin: 6px 0;
      line-height: 1.35;
    }
    #modal-body .hint{
      color:#666;
      font-size:0.9em;
      margin-top: 10px;
    }
    .sep{
      margin: 14px 0;
      border: none;
      border-top: 1px solid #ddd;
    }

    @media (max-width: 600px){
      body{ margin: 6px; }
      #line-svg{ height: 1050px; }
      #modal{ margin-top: 12vh; }
    }

  </style>
</head>
<body>
  <h1>æˆç”°ç©ºæ¸¯è¡Œãåˆ—è»Šä½ç½®æƒ…å ±</h1>
  <div style="text-align:center; font-size:0.95em; color:#555; margin-bottom:4px;">
    ã€Train information to Narita Airportã€‘
  </div>

  <div id="info-message"></div>
  <div id="alert-banner"></div>

  <div class="card">
    <svg id="line-svg" viewBox="0 0 380 1100"></svg>
  </div>

  <div id="last-updated"></div>

  <div id="modal-overlay" aria-hidden="true">
    <div id="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <div id="modal-header">
        <div id="modal-title">åˆ—è»Šæƒ…å ± / Train Details</div>
        <button id="modal-close" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      </div>
      <div id="modal-body">
        <div class="hint">
          è·¯ç·šå›³ã®åˆ—è»Šç•ªå·ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€ã“ã“ã«è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>
          Tap a train number on the map to see details.
        </div>
      </div>
    </div>
  </div>

  <script>
    const trainUrl = "https://api-public.odpt.org/api/v4/odpt:Train?odpt:operator=odpt.Operator:Toei";

    // ãƒ†ã‚¹ãƒˆé…å»¶ï¼š?testdelay=12
    const params = new URLSearchParams(location.search);
    const TEST_DELAY_MIN = Number(params.get("testdelay") || 0);

    // â˜…é…å»¶ãƒˆãƒªã‚¬ãƒ¼ï¼ˆäº¬æˆåŒºé–“è¡¨ç¤º / ãƒãƒŠãƒ¼ / ãƒ¢ãƒ¼ãƒ€ãƒ«æ³¨æ„æ–‡ï¼‰
    const DELAY_TRIGGER_MIN = 5;

    // æ—¥æœ¬èªé§…å
    const stationMap = {
      "KeiseiTakasago": "äº¬æˆé«˜ç ‚(KS-10)",
      "Aoto": "é’ç ¥(KS-09)",
      "KeiseiTateishi": "äº¬æˆç«‹çŸ³(KS-49)",
      "Yotsugi": "å››ãƒ„æœ¨(KS-48)",
      "Yahiro": "å…«åºƒ(KS-47)",
      "KeiseiHikifune": "äº¬æˆæ›³èˆŸ(KS-46)",

      "Oshiage": "æŠ¼ä¸Š(A-20)",
      "HonjoAzumabashi": "æœ¬æ‰€å¾å¦»æ©‹(A-19)",
      "Asakusa": "æµ…è‰(A-18)",
      "Kuramae": "è”µå‰(A-17)",
      "Asakusabashi": "æµ…è‰æ©‹(A-16)",
      "HigashiNihombashi": "æ±æ—¥æœ¬æ©‹(A-15)",
      "Ningyocho": "äººå½¢ç”º(A-14)",
      "Nihombashi": "æ—¥æœ¬æ©‹(A-13)",
      "Takaracho": "å®ç”º(A-12)",
      "HigashiGinza": "æ±éŠ€åº§(A-11)",
      "Shimbashi": "æ–°æ©‹(A-10)",
      "Daimon": "å¤§é–€(A-09)",
      "Mita": "ä¸‰ç”°(A-08)",
      "Sengakuji": "æ³‰å²³å¯º(A-07)",
      "Takanawadai": "é«˜è¼ªå°(A-06)",
      "Gotanda": "äº”åç”°(A-05)",
      "Togoshi": "æˆ¸è¶Š(A-04)",
      "Nakanobu": "ä¸­å»¶(A-03)",
      "Magome": "é¦¬è¾¼(A-02)",
      "NishiMagome": "è¥¿é¦¬è¾¼(A-01)",

      "NaritaAirportTerminal1": "æˆç”°ç©ºæ¸¯"
    };

    // è‹±èªé§…å
    const stationMapEn = {
      "KeiseiTakasago": "Keisei-Takasago",
      "Aoto": "Aoto",
      "KeiseiTateishi": "Keisei-Tateishi",
      "Yotsugi": "Yotsugi",
      "Yahiro": "Yahiro",
      "KeiseiHikifune": "Keisei-Hikifune",

      "Oshiage": "Oshiage (A-20)",
      "HonjoAzumabashi": "Honjo-Azumabashi (A-19)",
      "Asakusa": "Asakusa (A-18)",
      "Kuramae": "Kuramae (A-17)",
      "Asakusabashi": "Asakusabashi (A-16)",
      "HigashiNihombashi": "Higashi-Nihombashi (A-15)",
      "Ningyocho": "Ningyocho (A-14)",
      "Nihombashi": "Nihombashi (A-13)",
      "Takaracho": "Takaracho (A-12)",
      "HigashiGinza": "Higashi-Ginza (A-11)",
      "Shimbashi": "Shimbashi (A-10)",
      "Daimon": "Daimon (A-09)",
      "Mita": "Mita (A-08)",
      "Sengakuji": "Sengakuji (A-07)",
      "Takanawadai": "Takanawadai (A-06)",
      "Gotanda": "Gotanda (A-05)",
      "Togoshi": "Togoshi (A-04)",
      "Nakanobu": "Nakanobu (A-03)",
      "Magome": "Magome (A-02)",
      "NishiMagome": "Nishi-Magome (A-01)",

      "NaritaAirportTerminal1": "Narita Airport (KS-42)"
    };

    // ä¸Š=äº¬æˆé«˜ç ‚ â†’ â€¦ â†’ æŠ¼ä¸Š â†’ ä¸‹=è¥¿é¦¬è¾¼
    const stationOrderKey = [
      "KeiseiTakasago","Aoto","KeiseiTateishi","Yotsugi","Yahiro","KeiseiHikifune","Oshiage",
      "HonjoAzumabashi","Asakusa","Kuramae","Asakusabashi","HigashiNihombashi","Ningyocho","Nihombashi",
      "Takaracho","HigashiGinza","Shimbashi","Daimon","Mita","Sengakuji","Takanawadai","Gotanda","Togoshi",
      "Nakanobu","Magome","NishiMagome"
    ];

    // å³ãƒ¬ãƒ¼ãƒ³ã§è¡¨ç¤ºã—ãªã„é€šéé§…ï¼ˆæµ…è‰ç·šå†…ã®é€šéé§…ï¼‰
    const bypassStationKeys = new Set([
      "HigashiGinza","Takaracho","Ningyocho","Asakusabashi","Kuramae","HonjoAzumabashi"
    ]);

    // äº¬æˆåŒºé–“ï¼ˆæŠ¼ä¸Šã®ä¸Šã ã‘ï¼‰â€»æŠ¼ä¸Šã¯å«ã‚ãªã„
    const keiseiSectionKeys = new Set([
      "KeiseiTakasago","Aoto","KeiseiTateishi","Yotsugi","Yahiro","KeiseiHikifune"
    ]);

    // â˜…äº¬æˆåŒºé–“ã§ã€Œæ™®é€šä»¥å¤–ã¯é€šéã€æ‰±ã„ã«ã—ãŸã„é§…ï¼ˆåœè»Šâ—‹ã‚’æ¶ˆã™ï¼šå·¦å³ä¸¡ãƒ¬ãƒ¼ãƒ³ï¼‰
    const keiseiPassCircleKeys = new Set([
      "KeiseiHikifune",
      "Yahiro",
      "Yotsugi",
      "KeiseiTateishi"
    ]);

    let selectedTrainId = null;
    let latestTrainsById = new Map();
    let visibleStations = [];
    let lastRenderedTrains = [];

    function stationKeyFromUri(uri){
      if(!uri) return null;
      return uri.split(".").pop();
    }

    function translateStation(stationUri){
      if(!stationUri) return "ä¸æ˜";
      const key = stationKeyFromUri(stationUri);
      return stationMap[key] || key;
    }

    function translateStationEn(stationUri){
      if(!stationUri) return "Unknown";
      const key = stationKeyFromUri(stationUri);
      return stationMapEn[key] || key;
    }

    // ===URLæœ«å°¾ã«ã€€?testdelay=5ã€€ã“ã®å ´åˆï¼•åˆ†é…ã‚Œ
    function getDelayMin(train){
      const delay = train["odpt:delay"];
      const real = (delay && delay > 0) ? Math.round(delay/60) : 0;
      if(TEST_DELAY_MIN > 0) return Math.max(real, TEST_DELAY_MIN);
      return real;
    }

    function formatTrainNumber(raw){
      const s = raw || "";
      const m = s.match(/^(\d+)([A-Za-z]+)/);
      if(!m) return s || "??";
      const num = m[1];
      const letter = m[2].charAt(0).toUpperCase();
      const last2 = num.length >= 2 ? num.slice(-2) : num;
      return last2 + letter;
    }

    // ===== ç¨®åˆ¥ï¼šJA/ENï¼ˆãƒãƒ¼ã‚«ãƒ¼è‰²ï¼‰=====
    function getTrainTypeParts(train){
      const trainType = train["odpt:trainType"];
      const map = {
        "odpt.TrainType:Toei.Local": { ja:"æ™®é€š", en:"Local", bg:"#000000", fg:"#ffffff" },
        "odpt.TrainType:Toei.Rapid": { ja:"å¿«é€Ÿ", en:"Rapid", bg:"#ff66a3", fg:"#ffffff" },
        "odpt.TrainType:Toei.Express": { ja:"æ€¥è¡Œ", en:"Express", bg:"#007bff", fg:"#ffffff" },
        "odpt.TrainType:Toei.LimitedExpress": { ja:"ç‰¹æ€¥", en:"Limited Express", bg:"#dc3545", fg:"#ffffff" },
        "odpt.TrainType:Toei.RapidLimitedExpress": { ja:"å¿«é€Ÿç‰¹æ€¥", en:"Limited Express", bg:"#28a745", fg:"#ffffff" },
        "odpt.TrainType:Toei.CommuterLimitedExpress": { ja:"é€šå‹¤ç‰¹æ€¥", en:"Commuter Limited Express", bg:"#17a2b8", fg:"#ffffff" },
        "odpt.TrainType:Toei.AccessExpress": { ja:"ã‚¢ã‚¯ã‚»ã‚¹ç‰¹æ€¥", en:"Access Express", bg:"#fd7e14", fg:"#ffffff" },
        "odpt.TrainType:Toei.AirportRapidLimitedExpress": { ja:"âœˆã‚¨ã‚¢ãƒãƒ¼ãƒˆå¿«ç‰¹", en:"âœˆ Airport Limited Express", bg:"#fd7e14", fg:"#ffffff" }
      };
      return map[trainType] || { ja:"å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ", en:"Unavailable", bg:"#6c757d", fg:"#ffffff" };
    }

    // è¡Œå…ˆ
    function getDestinationJa(train){
      const destArr = train["odpt:destinationStation"] || [];
      return destArr.length ? destArr.map(translateStation).join(" â†’ ") : "ä¸æ˜";
    }
    function getDestinationEn(train){
      const destArr = train["odpt:destinationStation"] || [];
      return destArr.length ? destArr.map(translateStationEn).join(" â†’ ") : "Unknown";
    }

    // çµŒç”±ï¼ˆæ—¥æœ¬èª/è‹±èª + è‰²ä»˜ãHTMLï¼‰
    function getRouteInfoJaHtml(train){
      const destination = train["odpt:destinationStation"];
      if(!destination) return "ä¸æ˜";
      if(destination.some(st => st.includes("odpt.Station:Keisei.NaritaSkyAccess")))
        return `<span style="color:#fd7e14;font-weight:bold;">æˆç”°ã‚¹ã‚«ã‚¤ã‚¢ã‚¯ã‚»ã‚¹ç·š</span>`;
      if(destination.some(st => st.includes("odpt.Station:Keisei.Main")))
        return `<span style="color:#dc3545;font-weight:bold;">äº¬æˆæœ¬ç·š</span>`;
      return "ä¸æ˜";
    }

    function getRouteInfoEnHtml(train){
      const destination = train["odpt:destinationStation"];
      if(!destination) return "Unknown";
      if(destination.some(st => st.includes("odpt.Station:Keisei.NaritaSkyAccess")))
        return `<span style="color:#fd7e14;font-weight:bold;">Narita Sky Access Line.</span>`;
      if(destination.some(st => st.includes("odpt.Station:Keisei.Main")))
        return `<span style="color:#dc3545;font-weight:bold;">Keisei Main Line.</span>`;
      return "Unknown";
    }

    function isSkipTrain(train){
      return train["odpt:trainType"] === "odpt.TrainType:Toei.AirportRapidLimitedExpress";
    }

    // æ—¥æœ¬èªï¼šé€šé/åˆ°ç€/å‡ºç™º
    function getStatusText(train){
      const fromKey = stationKeyFromUri(train["odpt:fromStation"]);
      const from = translateStation(train["odpt:fromStation"]);
      const isStopped = !train["odpt:toStation"];

      if(isSkipTrain(train) && fromKey && bypassStationKeys.has(fromKey)){
        return `${from}ã‚’é€šéã—ã¾ã—ãŸã€‚`;
      }
      if(isStopped) return `${from}ã«åˆ°ç€ã—ã¾ã—ãŸã€‚`;
      return `${from}ã‚’å‡ºç™ºã—ã¾ã—ãŸã€‚`;
    }

    // è‹±èªï¼šPassed / Arrived / Departed
    function getTrainStatusEn(train) {
      const fromKey = stationKeyFromUri(train["odpt:fromStation"]);
      const isStopped = !train["odpt:toStation"];
      const fromEn = (fromKey && stationMapEn[fromKey]) ? stationMapEn[fromKey] : (fromKey || "Unknown");

      if (
        train["odpt:trainType"] === "odpt.TrainType:Toei.AirportRapidLimitedExpress" &&
        fromKey &&
        bypassStationKeys.has(fromKey)
      ) return `Passed ${fromEn}.`;

      if (isStopped) return `Arrived at ${fromEn}.`;
      return `Departed ${fromEn}.`;
    }

    function yOfStation(key){
      const idx = visibleStations.indexOf(key);
      if(idx < 0) return null;

      const top = 50;
      const bottom = 1050;

      if(visibleStations.length === 1) return (top + bottom) / 2;
      return top + (idx/(visibleStations.length-1))*(bottom-top);
    }

    function calcTrainY(train){
      const fromKey = stationKeyFromUri(train["odpt:fromStation"]);
      const toKey = stationKeyFromUri(train["odpt:toStation"]);
      const yFrom = fromKey ? yOfStation(fromKey) : null;
      if(!toKey) return yFrom;
      const yTo = yOfStation(toKey);
      if(yFrom == null || yTo == null) return yFrom ?? yTo;
      return (yFrom + yTo)/2;
    }

    // ===== è©³ç´°ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ï¼šäºŒæ®µï¼ˆä¸Šæ®µ æ—¥æœ¬èª / ä¸‹æ®µ Englishï¼‰=====
    function showDetail(train){
      const num = formatTrainNumber(train["odpt:trainNumber"]);
      const tp = getTrainTypeParts(train);

      const delayMin = getDelayMin(train);
      const isSevereDelay = delayMin >= DELAY_TRIGGER_MIN;

      const statusJa = getStatusText(train);
      const statusEn = getTrainStatusEn(train);

      const destJa = getDestinationJa(train);
      const destEn = getDestinationEn(train);

      const routeJaHtml = getRouteInfoJaHtml(train);
      const routeEnHtml = getRouteInfoEnHtml(train);

      // â˜…ã€Œâ—‹åˆ†é…ã‚Œã€ã ã‘èµ¤ï¼ˆ1åˆ†ä»¥ä¸Šã§è¡¨ç¤ºï¼‰
      const delayPrefixJa = (delayMin > 0)
        ? `<span style="color:#dc3545;font-weight:bold;">${delayMin}åˆ†é…ã‚Œ</span>ã§`
        : `å®šåˆ»é€šã‚Š`;

      const delayPrefixEn = (delayMin > 0)
        ? `<span style="color:#dc3545;font-weight:bold;">${delayMin} min delay.</span>`
        : `On time.`;

      const isAirportKaitoku =
        train["odpt:trainType"] === "odpt.TrainType:Toei.AirportRapidLimitedExpress";

      const stopNoteJa = !isAirportKaitoku ? " æŠ¼ä¸Š(A-20)ã¾ã§å„é§…ã«åœã¾ã‚Šã¾ã™ã€‚" : "";
      const stopNoteEn = !isAirportKaitoku ? " Stops at all stations until Oshiage (A-20)." : "";

      // â˜…5åˆ†ä»¥ä¸Šã®æ³¨æ„æ–‡ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã«ã®ã¿ï¼‰
      const noticeJa = "ã“ã®å…ˆã®çŠ¶æ³ã«ã‚ˆã‚Šé€”ä¸­ã®é§…ã§é‹è»¢ã‚’æ‰“ã¡åˆ‡ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚";
      const noticeEn = "Depending on the situation, trains may terminate at a station before the final destination.";

      openModal(`
        <!-- ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª -->
        <div style="font-size:1.02em; line-height:1.55;">
            <div class="row">
            <b>ç¨®åˆ¥ï¼š</b>
            <span style="display:inline-block;padding:3px 8px;border-radius:10px;background:${tp.bg};color:${tp.fg};">
              ${tp.ja}
            </span>${stopNoteJa}
          </div>

          <div class="row"><b>è¡Œå…ˆï¼š</b>${routeJaHtml}çµŒç”± ${destJa}è¡Œã</div>

          <div class="row"><b>é‹è¡ŒçŠ¶æ³ï¼š</b>${delayPrefixJa}${statusJa}</div>
          ${isSevereDelay ? `<div class="row" style="color:#dc3545;font-weight:bold;">${noticeJa}</div>` : ``}
        </div>

        <div class="hint">â€»20ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°</div>

        <hr class="sep">

        <!-- ğŸ‡¬ğŸ‡§ English -->
        <div style="font-size:0.90em; color:#666; line-height:1.45;">
           <div class="row">
            <b>Type:</b>
            <span style="display:inline-block;padding:2px 8px;border-radius:10px;background:${tp.bg};color:${tp.fg};">
              ${tp.en}
            </span><span style="color:#777; margin-left:8px;">${stopNoteEn}</span>
          </div>

          <div class="row"><b>Destination:</b> ${destEn} via ${routeEnHtml} </div>

          <div class="row"><b>Status:</b> ${delayPrefixEn} ${statusEn}</div>
          ${isSevereDelay ? `<div class="row" style="color:#dc3545;font-weight:bold;">${noticeEn}</div>` : ``}
        </div>

        <div class="hint">â€»Updates every 20 seconds</div>
      `);
    }

    /* ====== ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ ====== */
    const overlay = document.getElementById("modal-overlay");
    const modalBody = document.getElementById("modal-body");
    const btnClose = document.getElementById("modal-close");

    function openModal(html){
      modalBody.innerHTML = html;
      overlay.style.display = "block";
      overlay.setAttribute("aria-hidden", "false");
    }

    function closeModal(){
      overlay.style.display = "none";
      overlay.setAttribute("aria-hidden", "true");
      selectedTrainId = null;
      renderMap(lastRenderedTrains);
    }

    btnClose.onclick = closeModal;
    overlay.onclick = (e) => { if(e.target === overlay) closeModal(); };
    window.addEventListener("keydown", (e) => { if(e.key === "Escape") closeModal(); });

    // â˜…ãƒˆãƒªã‚¬ãƒ¼ 5åˆ†ï¼ˆãƒãƒŠãƒ¼ç”¨ï¼‰
    function updateAlertBanner(trains){
      const banner = document.getElementById("alert-banner");
      if(!banner) return;

      const severe = trains.filter(t => getDelayMin(t) >= DELAY_TRIGGER_MIN);
      if(severe.length === 0){
        banner.style.display = "none";
        banner.innerHTML = "";
        return;
      }

      banner.style.display = "block";
      banner.innerHTML = `
        <div class="title">ã€é‹è¡Œæƒ…å ±ã€‘</div>
        <div>é…ã‚ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚</div>
        <div>æˆç”°ç©ºæ¸¯è¡Œãã®é›»è»Šã¯ã€æŠ¼ä¸Šé§…ã‹ã‚‰ï¼–é§…å…ˆã®äº¬æˆé«˜ç ‚é§…ã§ãŠå¾…ã¡ãã ã•ã„ã€‚</div>
        <div style="margin-top:6px;"><b>ã€Service Informationã€‘</b></div>
        <div>Service delays are occurring. Please wait for Narita Airportâ€“bound trains at Keisei-Takasago (KS-10), six stations from Oshiage.</div>
      `;
    }

function drawTrainMarker(svg, x, y, color, label, trainId, delaySide){
  const train = latestTrainsById.get(trainId);
  const delayMin = train ? getDelayMin(train) : 0;
  const isDelayed = delayMin > 0;

  // â˜… æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ãã®ã¾ã¾æµç”¨
  const isStopped = train ? !train["odpt:toStation"] : false;

  /* ===== é•·æ–¹å½¢ ===== */
  const rectH = 34;
  const rectW = 16;
  const radius = 4;

  const halfH = rectH / 2;
  const halfW = rectW / 2;

  /* ===== ä¸‰è§’ï¼ˆé»’ãƒ»ä¸Šå‘ãï¼‰ ===== */
  const triW = 10;
  const triH = 6;
  const triGap = 4;

  const triY = y - halfH - triGap;

  const triPoints = `
    ${x},${triY - triH}
    ${x - triW / 2},${triY}
    ${x + triW / 2},${triY}
  `;

  /* ===== é…å»¶è¡¨ç¤º ===== */
  const gap = 8;
  const delayY = y + 6;
  const delayX = (delaySide === "left")
    ? (x - halfW - gap)
    : (x + halfW + gap);
  const delayAnchor = (delaySide === "left") ? "end" : "start";

  svg.insertAdjacentHTML(
    "beforeend",
    `<g class="train-marker ${isStopped ? "" : "moving"}"
        data-train-id="${trainId}">

      <!-- â–² ç™½ç¸ -->
      <polygon
        class="train-triangle"
        points="${triPoints}"
        fill="#ffffff"
      ></polygon>

      <!-- â–² æœ¬ä½“ï¼ˆé»’ï¼‰ -->
      <polygon
        class="train-triangle"
        points="${triPoints}"
        transform="translate(0,1)"
        fill="#000000"
      ></polygon>

      <!-- â–  ç™½ç¸ -->
      <rect
        x="${x - halfW}"
        y="${y - halfH}"
        width="${rectW}"
        height="${rectH}"
        rx="${radius}"
        ry="${radius}"
        fill="#ffffff"
      ></rect>

      <!-- â–  æœ¬ä½“ï¼ˆç¨®åˆ¥è‰²ï¼‰ -->
      <rect
        x="${x - halfW}"
        y="${y - halfH}"
        width="${rectW}"
        height="${rectH}"
        rx="${radius}"
        ry="${radius}"
        fill="${color}"
      ></rect>

      ${isDelayed ? `
        <text
          x="${delayX}"
          y="${delayY}"
          font-size="12"
          text-anchor="${delayAnchor}"
          fill="#ff0000"
          font-weight="bold">+${delayMin}</text>
      ` : ``}
    </g>`
  );
}






    function renderMap(trains){
      const svg = document.getElementById("line-svg");
      if(!svg) return;

      lastRenderedTrains = trains;
      svg.innerHTML = "";

      // â˜…é…ã‚Œãƒˆãƒªã‚¬ãƒ¼ 5åˆ†ï¼ˆäº¬æˆåŒºé–“è¡¨ç¤ºï¼‰
      const severeDelay = trains.some(t => getDelayMin(t) >= DELAY_TRIGGER_MIN);

      visibleStations = stationOrderKey.filter(key => {
        if(!severeDelay && keiseiSectionKeys.has(key)) return false;
        return true;
      });

      // â˜…ã‚¨ã‚¢ãƒãƒ¼ãƒˆå¿«ç‰¹ãŒå­˜åœ¨ã™ã‚‹ã‹
      const hasAirportKaisoku = trains.some(
        t => t["odpt:trainType"] === "odpt.TrainType:Toei.AirportRapidLimitedExpress"
      );

      const xStopLine = 130;
      const xSkipLine = 270;
      const xStation  = 200;

      const xStopTrain = xStopLine - 45;
      const xSkipTrain = xSkipLine + 45;

      const startY = yOfStation(visibleStations[0]);
      const endY = yOfStation(visibleStations[visibleStations.length - 1]);

      // ===== ä¸Šæ–¹å‘ã«ã€Œç¶šãã€ã‚’è¦‹ã›ã‚‹å»¶é•·ï¼ˆå®Ÿç·šï¼‰=====
      const yNext = (visibleStations.length >= 2) ? yOfStation(visibleStations[1]) : null;
      const stationGap = (yNext != null) ? Math.abs(yNext - startY) : 40;
      const extLen = stationGap * 0.9;
      const extTopY = startY - extLen;

      // ===== ç¸¦ç·šï¼šå·¦ï¼ˆé»’1æœ¬ï¼‰/ å³ï¼ˆæ©™æ ï¼‹ç™½ï¼‰=====
      // å·¦ãƒ¬ãƒ¼ãƒ³ï¼šé»’1æœ¬ï¼ˆå³ãƒ¬ãƒ¼ãƒ³ç™½=6ã«åˆã‚ã›ã‚‹ï¼‰
      svg.insertAdjacentHTML("beforeend",
        `<line x1="${xStopLine}" y1="${extTopY}" x2="${xStopLine}" y2="${endY}"
               stroke="#000" stroke-width="6" stroke-linecap="round"></line>`
      );

      // å³ãƒ¬ãƒ¼ãƒ³ï¼šæ©™1æœ¬ç·šï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
      const ySengakuji = yOfStation("Sengakuji");

if (hasAirportKaisoku) {
  svg.insertAdjacentHTML("beforeend",
   `<line id="airport-line"
          x1="${xSkipLine}" y1="${extTopY}"
          x2="${xSkipLine}" y2="${ySengakuji}"
          stroke="#ff8c00"
          stroke-width="6"
          stroke-linecap="round"></line>`
  );
}

      // é§…è¡¨ç¤º
      visibleStations.forEach(key => {
        const y = yOfStation(key);
const nameJa = stationMap[key] || key;

const nameEnRaw = stationMapEn[key] || "";
const nameEn = nameEnRaw.replace(/\s*\([A-Z]{1,2}-\d+\)/, "");


        // â˜…é…ã‚Œè¡¨ç¤ºä¸­ã ã‘ï¼šæŒ‡å®šé§…ã®åœè»Šâ—‹ï¼ˆå·¦å³ï¼‰ã‚’æ¶ˆã™
        const hideCircle = severeDelay && keiseiPassCircleKeys.has(key);

        // å·¦ãƒ¬ãƒ¼ãƒ³ï¼šåœè»Šâ—‹ï¼ˆ1å€‹ï¼‰
        if(!hideCircle){
          svg.insertAdjacentHTML("beforeend",
            `<circle cx="${xStopLine}" cy="${y}" r="6"
                     fill="#fff" stroke="#000" stroke-width="2"></circle>`
          );
        }

        // å³ãƒ¬ãƒ¼ãƒ³â—‹ï¼ˆæµ…è‰ç·šå†…ã®é€šéé§…ã¯å…ƒã€…éè¡¨ç¤ºï¼‰
        // å³ãƒ¬ãƒ¼ãƒ³â—‹ï¼ˆæ³‰å²³å¯ºã‚ˆã‚Šä¸‹ã¯æã‹ãªã„ï¼‰
if(
  hasAirportKaisoku &&           // â˜…è¿½åŠ 
  !bypassStationKeys.has(key) &&
  !hideCircle &&
  y <= yOfStation("Sengakuji")
){
  svg.insertAdjacentHTML("beforeend",
    `<circle cx="${xSkipLine}" cy="${y}" r="6"
             fill="#fff" stroke="#ff8c00" stroke-width="1"></circle>`
  );
}

        // é§…å
        svg.insertAdjacentHTML("beforeend",
          `<text x="${xStation}" y="${y - 2}"
                 font-size="14"
                 font-weight="bold"
                 text-anchor="middle"
                 fill="#222">${nameJa}</text>
           <text x="${xStation}" y="${y + 14}"
                 font-size="11"
                 text-anchor="middle"
                 fill="#777">${nameEn}</text>`
        );
      });

      // åˆ—è»Šãƒãƒ¼ã‚«ãƒ¼
      trains.forEach(train => {
        const y = calcTrainY(train);
        if(y == null) return;

        const id = train["odpt:trainNumber"] || train["@id"] || ("t_" + Math.random());
        latestTrainsById.set(id, train);

        const label = formatTrainNumber(train["odpt:trainNumber"] || "");
        const tp = getTrainTypeParts(train);

        if(isSkipTrain(train)){
          drawTrainMarker(svg, xSkipTrain, y, tp.bg, label, id, "right");
        }else{
          drawTrainMarker(svg, xStopTrain, y, tp.bg, label, id, "left");
        }
      });

      // ã‚¿ãƒƒãƒ— â†’ ãƒ¢ãƒ¼ãƒ€ãƒ«
      svg.onclick = (ev) => {
        const g = ev.target.closest(".train-marker");
        if(!g) return;

        const id = g.getAttribute("data-train-id");
        const train = latestTrainsById.get(id);
        if(!train) return;

        selectedTrainId = id;
        showDetail(train);

        renderMap(Array.from(latestTrainsById.values()));
      };

      
    }

    function loadTrainData(){
      fetch(trainUrl)
        .then(res => res.json())
        .then(trainData => {
          // æˆç”°ç©ºæ¸¯è¡Œãã®ã¿æŠ½å‡º
          const naritaAirportTrains = trainData.filter(train =>
            train["odpt:destinationStation"] &&
            train["odpt:destinationStation"].some(dest => dest.includes("NaritaAirport"))
          );

          const info = document.getElementById("info-message");
          if(info){
            if (naritaAirportTrains.length === 0) {
              info.innerHTML =
                "ç¾åœ¨ã€æˆç”°ç©ºæ¸¯è¡Œãã®åˆ—è»Šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>" +
                "ã€There are currently no trains bound for Narita Airport.ã€‘";
            } else {
              info.innerHTML =
                "è¡¨ç¤ºä¸­ã®åˆ—è»Šã¯ã™ã¹ã¦æˆç”°ç©ºæ¸¯è¡Œãã§ã™ã€‚<br>" +
                "ã€All trains shown are bound for Narita Airport.ã€‘";
            }
          }

          updateAlertBanner(naritaAirportTrains);

          const prevSelected = selectedTrainId;

          latestTrainsById = new Map();
          renderMap(naritaAirportTrains);

          if(prevSelected && latestTrainsById.has(prevSelected)){
            selectedTrainId = prevSelected;
            if(overlay.style.display === "block"){
              showDetail(latestTrainsById.get(prevSelected));
            }
          }else{
            selectedTrainId = null;
          }

          const now = new Date();
          const hh = now.getHours().toString().padStart(2,"0");
          const mm = now.getMinutes().toString().padStart(2,"0");
          const ss = now.getSeconds().toString().padStart(2,"0");
          document.getElementById("last-updated").innerHTML =
            `æ›´æ–°æ™‚åˆ»ã€Update Timeã€‘: ${hh}:${mm}:${ss}<BR>20ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™ã€‚ã€Automatically updates every 20 seconds.ã€‘`;
        })
        .catch(() => {
  // ä¸Šéƒ¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  document.getElementById("info-message").innerHTML =
    "åˆ—è»Šæƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br>" +
    "ã€Train information is temporarily unavailable.ã€‘";

  // é‹è¡Œæƒ…å ±ãƒãƒŠãƒ¼ã¯éè¡¨ç¤º
  document.getElementById("alert-banner").style.display = "none";
  document.getElementById("alert-banner").innerHTML = "";

  // è·¯ç·šå›³ã‚’ã‚¯ãƒªã‚¢ï¼ˆé‡è¦ï¼‰
  const svg = document.getElementById("line-svg");
  if (svg) svg.innerHTML = "";

  // æ›´æ–°æ™‚åˆ»æ¬„
  document.getElementById("last-updated").innerHTML =
    "æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã€Failed to retrieve dataã€‘";
});
    }

    loadTrainData();
    setInterval(loadTrainData, 20000);
  </script>
</body>
</html>
